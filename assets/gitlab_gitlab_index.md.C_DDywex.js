import{_ as i,c as a,o as t,ae as l}from"./chunks/framework.DtxlzkAV.js";const g=JSON.parse('{"title":"gitlab","description":"","frontmatter":{"sidebar":"auto"},"headers":[],"relativePath":"gitlab/gitlab/index.md","filePath":"gitlab/gitlab/index.md"}'),n={name:"gitlab/gitlab/index.md"};function h(p,s,e,k,r,d){return t(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="gitlab" tabindex="-1">gitlab <a class="header-anchor" href="#gitlab" aria-label="Permalink to &quot;gitlab&quot;">​</a></h1><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>gitlab 的<a href="https://about.gitlab.com/install/" target="_blank" rel="noreferrer">官方安装</a>地址 我使用的系统为 debian+docker+gitlab-EE</p></div><h2 id="debian" tabindex="-1">Debian <a class="header-anchor" href="#debian" aria-label="Permalink to &quot;Debian&quot;">​</a></h2><h3 id="安装-install" tabindex="-1">安装(install) <a class="header-anchor" href="#安装-install" aria-label="Permalink to &quot;安装(install)&quot;">​</a></h3><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>在官方一般是显示 <strong>gitlab-EE</strong> 版本,中国用户可能是显示<strong>极狐</strong>版本,建议可以根据官方文档搭建完环境,然后在<a href="https://packages.gitlab.com/gitlab" target="_blank" rel="noreferrer">官方仓库</a>挑选版本,可以根据 Distro/version 挑选合适的安装包,点击安装包后右上角也会显示如何添加/修改仓库,来使用系统自带的管理工具安装</p></div><ol><li>首先安装下必要环境</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>sudo apt update</span></span>
<span class="line"><span>sudo apt install -y curl openssh-server ca-certificates perl postfix</span></span></code></pre></div><ol start="2"><li>添加仓库,可以使用官方示例的 ee 脚本,也可以在 tip 指引的[官方仓库]中寻找</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | sudo bash</span></span></code></pre></div><ol start="3"><li>使用自带管理工具安装,安装前可设置 EXTERNAL_URL 变量提前指定域名,也可以在稍后通过 rb 文件修改</li></ol><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>如果你没有域名的话,请使用 http 协议+ip 地址,如 EXTERNAL_URL=&quot;<a href="http://192.168.1.1" target="_blank" rel="noreferrer">http://192.168.1.1</a>&quot;</p></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>sudo apt update</span></span>
<span class="line"><span>sudo EXTERNAL_URL=&quot;https://your.domain&quot; apt install gitlab-ee</span></span></code></pre></div><ol start="4"><li>登录 安装完毕后非指定的情况下会生成随机密码,路径在<code>/etc/gitlab/initial_root_password</code>,使用 root 用户即可登录 gitlab 了</li></ol><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>密码文件会在 24 小时后的下次运行/重启后删除,请注意<strong>记录</strong>或者及时修改你的<strong>root</strong>密码</p></div><h2 id="docker" tabindex="-1">docker <a class="header-anchor" href="#docker" aria-label="Permalink to &quot;docker&quot;">​</a></h2><h3 id="安装" tabindex="-1">安装 <a class="header-anchor" href="#安装" aria-label="Permalink to &quot;安装&quot;">​</a></h3><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>docker 提供了多种安装方式,具体可以参照<a href="https://docs.gitlab.com/ee/install/docker.html" target="_blank" rel="noreferrer">官方说明</a> 本次就介绍下<strong>Docker Compose</strong>的配置文件</p></div><p>docker 的安装请参考<a href="https://docs.docker.com/get-docker/" target="_blank" rel="noreferrer">官方文档</a> docker componse v2 的<a href="https://docs.docker.com/compose/cli-command/#installing-compose-v2" target="_blank" rel="noreferrer">安装文档</a></p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>docker componse 建议直接使用 v2 版本,体验比 v1 版本好不少,docker-componse 命令可以使用 Compose Switch 来添加自定义命令来保证命令的兼容性</p></div><h3 id="docker-compose-yml" tabindex="-1">docker-compose.yml <a class="header-anchor" href="#docker-compose-yml" aria-label="Permalink to &quot;docker-compose.yml&quot;">​</a></h3><p>参考配置</p><div class="language-yml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    web</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        image</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;gitlab/gitlab-ee:latest&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        container_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;gitlab&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        restart</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">always</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        hostname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;your.domian&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        environment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">            GITLAB_OMNIBUS_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #gitlab.rb的自定义配置,可以参照下面的gitlab.rb</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                # Add any other gitlab.rb configuration here, each on its own line</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                # gitlab Configre</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                external_url &#39;https://your.domian:xxxx&#39; #使用非80,443的端口可以在国内避免备案</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        ports</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;xxxx:xxxx&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;xxxx2:22&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        volumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/srv/gitlab/config:/etc/gitlab&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/srv/gitlab/logs:/var/log/gitlab&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/srv/gitlab/data:/var/opt/gitlab&quot;</span></span></code></pre></div><h3 id="运行" tabindex="-1">运行 <a class="header-anchor" href="#运行" aria-label="Permalink to &quot;运行&quot;">​</a></h3><p>v1 命令 <code>docker-compose up -d</code></p><p>v2 命令 <code>docker compose up -d</code></p><h3 id="更新" tabindex="-1">更新 <a class="header-anchor" href="#更新" aria-label="Permalink to &quot;更新&quot;">​</a></h3><ol><li>拉取新的 image <code>docker-compose pull</code></li><li>关闭原有的 docker 任务 <code>docker-compose down</code></li><li>重新启动 docker 任务,请勿使用 reset <code>docker-compose up-d</code></li></ol><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>docker 版本的更新请注意<strong>版本号</strong>,在<strong>大版本</strong>更新时需要按照<code>指定版本号</code>的步骤进行升级</p></div><h2 id="gitlab-rb" tabindex="-1">gitlab.rb <a class="header-anchor" href="#gitlab-rb" aria-label="Permalink to &quot;gitlab.rb&quot;">​</a></h2><p>gitlab 主要的配置文件</p><p>一般建议添加的配置如下</p><div class="language-rb vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rb</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Add any other gitlab.rb configuration here, each on its own line</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # gitlab Configre</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    external_url </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;https://your.domian:xxxx&#39;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #使用非80,443的端口可以在国内避免备案</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gitlab_rails[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;gitlab_shell_ssh_port&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> xxxx2  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#ssl端口,主要影响页面生成的配置文件,实际应用主要还是靠下方的映射</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    nginx[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;listen_port&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> xxxx </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#监听nginx端口</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    nginx[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;redirect_http_to_https&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  #是否开启http强制跳转</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    nginx[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ssl_certificate&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/etc/gitlab/cert/cert.pem&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  #ssl证书</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    nginx[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ssl_certificate_key&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/etc/gitlab/cert/privkey.pem&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  #ssl证书</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    letsencrypt[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;enable&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #自动证书,自动证书请看自身情况,我有其他服务器提供域名证书,不需要进行自签</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gitlab_rails[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;registry_enabled&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  #校验</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gitlab_rails[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;backup_archive_permissions&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0644</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #生成的备份文件权限</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gitlab_rails[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;backup_keep_time&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7776000</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #备份保留天数，秒计算</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # email,请自行配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gitlab_rails[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;gitlab_email_from&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;xxxx@mail.com&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gitlab_rails[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;smtp_enable&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gitlab_rails[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;smtp_address&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;smtp.mail.com&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gitlab_rails[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;smtp_port&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 25</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gitlab_rails[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;smtp_user_name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;xxxx@qq.com&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gitlab_rails[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;smtp_password&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;pwd&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gitlab_rails[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;smtp_domain&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mail.com&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    gitlab_rails[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;smtp_authentication&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;login&quot;</span></span></code></pre></div><h2 id="备份-还原" tabindex="-1">备份/还原 <a class="header-anchor" href="#备份-还原" aria-label="Permalink to &quot;备份/还原&quot;">​</a></h2><h3 id="全局情况" tabindex="-1">全局情况 <a class="header-anchor" href="#全局情况" aria-label="Permalink to &quot;全局情况&quot;">​</a></h3><ol><li>确定 rsync 已安装</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Debian/Ubuntu</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsync</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># RHEL/CentOS</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> yum</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsync</span></span></code></pre></div><ol start="2"><li>备份</li></ol><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>GitLab 不备份任何配置文件(/etc/gitlab)、TLS 密钥和证书或系统文件。强烈建议您阅读有关<a href="https://docs.gitlab.com/ee/raketasks/backup_restore.html#storing-configuration-files" target="_blank" rel="noreferrer">存储配置</a>文件的信息。</p></div><p>配置文件大致</p><ul><li><p>/etc/gitlab/gitlab-secrets.json</p></li><li><p>/etc/gitlab/gitlab.rb</p></li><li><p>pem 证书</p><p>备份命令如下</p></li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gitlab-backup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span></span></code></pre></div><p>备份的默认路径为<code>/var/opt/gitlab/backups</code>,文件名为<code>\${时间}_\${版本}_gitlab_backup.tar</code></p><ol start="3"><li>还原/迁移</li></ol><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>先将备份的配置文件还原到相应位置,并确认版本相同 确保 tar 文件在<strong>backups</strong>(默认<code>/var/opt/gitlab/backups</code>)中</p></div><p>还原命令</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gitlab-backup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restore</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> BACKUP=11493107454_2018_04_25_10.6.4-ce</span></span></code></pre></div><p>BACKUP=部分为文件<code>_gitlab_backup.tar</code> 前部分</p><h3 id="docker-1" tabindex="-1">docker <a class="header-anchor" href="#docker-1" aria-label="Permalink to &quot;docker&quot;">​</a></h3><p>备份命令</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">container</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gitlab-backup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span></span></code></pre></div><p>备份文件在<code>{docker}/data/backups/</code>中</p><p>恢复命令</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>其实命令和原生没什么区别,也可以<code>docker exec -it &lt;name of container&gt; bash</code> 进入容器内执行 或者直接备份好映射的<code>data</code>,<code>config</code>,<code>logs</code>即可</p></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Stop the processes that are connected to the database</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gitlab-ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> puma</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gitlab-ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sidekiq</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Verify that the processes are all down before continuing</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gitlab-ctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Run the restore. NOTE: &quot;_gitlab_backup.tar&quot; is omitted from the name</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gitlab-backup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restore</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> BACKUP=11493107454_2018_04_25_10.6.4-ce</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Restart the GitLab container</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Check GitLab</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> of</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gitlab-rake</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gitlab:check</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SANITIZE=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div>`,54)])])}const c=i(n,[["render",h]]);export{g as __pageData,c as default};
